services:
  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 20s

  redis:
    image: redis:7.0.11
    container_name: redis
    ports:
      - "6379:6379"

  mongodb:
    image: mongo:6
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: password
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  notification-server:
    build: ./notification-server
    container_name: notification-server
    restart: always
    environment:
      MONGO_URL: mongodb://root:password@mongodb:27017/notification?authSource=admin
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
    depends_on:
      rabbitmq:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    ports:
      - "5001:5001"

  frontend:
    build:
      context: ./viona
      args:
        # âœ… Pass NEXT_PUBLIC_* variables as build arguments
        NEXT_PUBLIC_NOTIFICATION_SERVER_URL: http://localhost:5001
        NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
        NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME: ${NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME}
        NEXT_PUBLIC_CLERK_SIGN_IN_URL: /sign-in
        NEXT_PUBLIC_CLERK_SIGN_UP_URL: /sign-up
    container_name: viona-frontend
    ports:
      - "3000:3000"
    environment:
      # Runtime environment variables (server-side only)
      NODE_ENV: production
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY}
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: redis://redis:6379 
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
    depends_on:
      rabbitmq:
        condition: service_healthy
      notification-server:
        condition: service_started
      redis:
        condition: service_started

  ai-agent-server:
    build: ./ai-agent-server
    container_name: ai-agent-server
    restart: always
    ports:
      - "8000:8000"
    env_file:
      - ./ai-agent-server/.env
    environment:
      # Clerk Auth - Use your Clerk instance JWKS URL
      CLERK_JWKS_URL: https://climbing-raven-91.clerk.accounts.dev/.well-known/jwks.json
      # Infrastructure Overrides (Docker Network)
      REDIS_URL: redis://redis:6379
      MONGO_URL: mongodb://root:password@mongodb:27017
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      # Shared Secrets
      DATABASE_URL: ${DATABASE_URL}
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_started
      mongodb:
        condition: service_healthy

volumes:
  mongodb_data: